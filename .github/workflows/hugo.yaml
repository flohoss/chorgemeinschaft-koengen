name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '24'
  HUGO_VERSION: '0.154.4'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install and run CMS
        run: |
          npm install
          npm run cms

      - name: Cache Hugo
        id: cache-hugo
        uses: actions/cache@v4
        with:
          path: /tmp/hugo_extract
          key: hugo-${{ env.HUGO_VERSION }}-${{ runner.os }}-${{ runner.arch }}

      - name: Install Hugo
        if: steps.cache-hugo.outputs.cache-hit != 'true'
        run: |
          ARCH=$(dpkg --print-architecture)
          wget -O /tmp/hugo.tar.gz https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-${ARCH}.tar.gz
          mkdir -p /tmp/hugo_extract
          tar -C /tmp/hugo_extract -xzf /tmp/hugo.tar.gz hugo
          chmod +x /tmp/hugo_extract/hugo
          rm /tmp/hugo.tar.gz

      - name: Add Hugo to PATH
        run: echo "/tmp/hugo_extract" >> $GITHUB_PATH

      - name: Build Hugo site
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
        run: |
          hugo version
          hugo --gc --minify --baseURL "https://chorgemeinschaft-koengen.de/"
        working-directory: ./app

      - name: Setup Rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG_BASE64 }}

      - name: Deploy with rclone sync
        run: |
          rclone sync ./app/public/ chor:webseite/ \
            --transfers=4 \
            --checkers=4 \
            --fast-list \
            --retries=3 \
            --low-level-retries=10
